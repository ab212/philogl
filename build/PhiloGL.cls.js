/*

 Copyright (c) 2011 Sencha Labs - Author: Nicolas Garcia Belmonte (http://philogb.github.com/)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){function u(y){return document.getElementById(y)}this.PhiloGL=null;(function(){PhiloGL=function(y,x){function m(r,w,s){var A=r.canvas,a=new PhiloGL.Camera(j.fov,j.aspect||A.width/A.height,j.near,j.far,j);a.update();var b=new PhiloGL.Scene(w,a,c);M=new PhiloGL.WebGL.Application({gl:r,canvas:A,program:w,scene:b,camera:a});w.$$family=="program"&&w.use();f&&PhiloGL.Events.create(M,u.extend(f,{bind:M}));if(d.src.length)new PhiloGL.IO.Textures(u.extend(d,{onComplete:function(){s(M)}}));else s(M)}
x=u.merge({context:{},camera:{fov:45,near:0.1,far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:u.empty,onError:u.empty},x||{});var n=x.context,j=x.camera,f=x.events,d=x.textures,h=u.splat(x.program),c=x.scene;p=PhiloGL.WebGL.getContext(y,n);if(!p){x.onError("The WebGL context couldn't been initialized");return null}var i={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},k=h.length,l=function(){var r=
k,w={},s=false;return{onSuccess:function(A,a){w[a.id||k-r]=A;r--;if(r===0&&!s)m(p,k==1?A:w,function(b){x.onLoad(b)})},onError:function(A){r--;x.onError(A);s=true}}}();h.forEach(function(r){var w=r.from,s,A;for(A in i)if(w==A){try{s=PhiloGL.Program[i[A]](u.extend(l,r))}catch(a){l.onError(a)}break}if(s)l.onSuccess(s,r)})}})();PhiloGL.unpack=function(y){y=y||aa;["Vec3","Mat4","Quat","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx","Media"].forEach(function(x){y[x]=
PhiloGL[x]});y.gl=p;y.Utils=u};PhiloGL.version="1.5.2";var p,M,aa=this;u.empty=function(){};u.time=Date.now;u.uid=function(){var y=u.time();return function(){return y++}}();u.extend=function(y,x){for(var m in x)y[m]=x[m];return y};u.type=function(){var y=Object.prototype.toString;return function(x){var m;m=y.call(x);m=m.substr(8,m.length-9).toLowerCase();if(m!="object")return m;if(x.$$family)return x.$$family;return x&&x.nodeName&&x.nodeType==1?"element":m}}();(function(){function y(x){var m=u.type(x);
if(m=="object"){m={};for(var n in x)m[n]=y(x[n]);return m}else if(m=="array"){m=[];n=0;for(var j=x.length;n<j;n++)m[n]=y(x[n]);return m}else return x}u.merge=function(){for(var x={},m=0,n=arguments.length;m<n;m++){var j=arguments[m];if(u.type(j)=="object")for(var f in j){var d=j[f],h=x[f];x[f]=h&&u.type(d)=="object"&&u.type(h)=="object"?u.merge(h,d):y(d)}}return x}})();u.splat=function(){var y=Array.isArray;return function(x){return y(x)&&x||[x]}}();(function(){function y(m){for(var n in m)this[n]=
m[n];this.buffers={};this.bufferMemo={};this.frameBuffers={};this.frameBufferMemo={};this.renderBuffers={};this.renderBufferMemo={};this.textures={};this.textureMemo={}}var x={getContext:function(m,n){m=typeof m=="string"?u(m):m;var j;(j=m.getContext("experimental-webgl",n))||(j=m.getContext("webgl",n));if(j&&n&&n.debug){p={};for(var f in j){var d=j[f];p[f]=typeof d=="function"?function(h,c){return function(){console.log(h,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));
try{var i=c.apply(j,arguments)}catch(k){throw h+" "+k;}for(var l=[],r;(r=j.getError())!==j.NO_ERROR;)l.push(r);if(l.length)throw l.join();return i}}(f,d):d}}else p=j;if(p)p.get=function(h){return typeof h=="string"?p[h]:h};return p}};y.prototype={$$family:"application",setBuffer:function(m,n,j){if(j===false||j===null){(j=this.bufferMemo[n])&&p.bindBuffer(j.bufferType,null);var f=j&&j.attribute||n;m=m.attributes[f];m!==undefined&&p.disableVertexAttribArray(m)}else{j=u.extend(this.bufferMemo[n]||{bufferType:p.ARRAY_BUFFER,
size:1,dataType:p.FLOAT,stride:0,offset:0,drawType:p.STATIC_DRAW},j||{});f=j.attribute||n;var d=j.bufferType,h=n in this.buffers,c=h?this.buffers[n]:p.createBuffer(),i="value"in j,k=j.value,l=j.size,r=j.dataType,w=j.stride,s=j.offset,A=j.drawType;m=m.attributes[f];var a=m!==undefined;h||(this.buffers[n]=c);a&&p.enableVertexAttribArray(m);p.bindBuffer(d,c);i&&p.bufferData(d,k,A);a&&p.vertexAttribPointer(m,l,r,false,w,s);delete j.value;this.bufferMemo[n]=j;if(a)this.bufferMemo[f]=j;return this}},setBuffers:function(m,
n){for(var j in n)this.setBuffer(m,j,n[j]);return this},setFrameBuffer:function(m,n){if(typeof n!="object")p.bindFramebuffer(p.FRAMEBUFFER,n?this.frameBuffers[m]:null);else{n=u.merge(this.frameBufferMemo[m]||{width:0,height:0,bindToTexture:false,textureOptions:{attachment:p.COLOR_ATTACHMENT0},bindToRenderBuffer:false,renderBufferOptions:{attachment:p.DEPTH_ATTACHMENT}},n||{});var j=n.bindToTexture,f=n.bindToRenderBuffer,d=m in this.frameBuffers,h=d?this.frameBuffers[m]:p.createFramebuffer();p.bindFramebuffer(p.FRAMEBUFFER,
h);d||(this.frameBuffers[m]=h);if(j){j=u.merge({data:{width:n.width,height:n.height}},u.type(j)=="object"?j:{});d=m+"-texture";h=n.textureOptions;this.setTexture(d,j);p.framebufferTexture2D(p.FRAMEBUFFER,h.attachment,this.textureMemo[d].textureType,this.textures[d],0)}if(f){f=u.extend({width:n.width,height:n.height},u.type(f)=="object"?f:{});j=m+"-renderbuffer";d=n.renderBufferOptions;this.setRenderBuffer(j,f);p.framebufferRenderbuffer(p.FRAMEBUFFER,d.attachment,p.RENDERBUFFER,this.renderBuffers[j])}p.bindTexture(p.TEXTURE_2D,
null);p.bindRenderbuffer(p.RENDERBUFFER,null);p.bindFramebuffer(p.FRAMEBUFFER,null);this.frameBufferMemo[m]=n;return this}},setFrameBuffers:function(m){for(var n in m)this.setFrameBuffer(n,m[n]);return this},setRenderBuffer:function(m,n){if(typeof n!="object")p.bindRenderbuffer(p.RENDERBUFFER,n?this.renderBufferMemo[m]:null);else{n=u.extend(this.renderBufferMemo[m]||{storageType:p.DEPTH_COMPONENT16,width:0,height:0},n||{});var j=m in this.renderBuffers,f=j?this.renderBuffers[m]:p.createRenderbuffer(p.RENDERBUFFER);
j||(this.renderBuffers[m]=f);p.bindRenderbuffer(p.RENDERBUFFER,f);p.renderbufferStorage(p.RENDERBUFFER,n.storageType,n.width,n.height);this.renderBufferMemo[m]=n;return this}},setRenderBuffers:function(m){for(var n in m)this.setRenderBuffer(n,m[n]);return this},setTexture:function(m,n){if(!n||typeof n!="object"){p.activeTexture(n||p.TEXTURE0);p.bindTexture(this.textureMemo[m].textureType||p.TEXTURE_2D,this.textures[m])}else{if(n.data&&n.data.type===p.FLOAT)if(!p.getExtension("OES_texture_float"))throw"OES_texture_float is not supported";
n=u.merge(this.textureMemo[m]||{textureType:p.TEXTURE_2D,pixelStore:[{name:p.UNPACK_FLIP_Y_WEBGL,value:true},{name:p.UNPACK_ALIGNMENT,value:1}],parameters:[{name:p.TEXTURE_MAG_FILTER,value:p.NEAREST},{name:p.TEXTURE_MIN_FILTER,value:p.NEAREST},{name:p.TEXTURE_WRAP_S,value:p.CLAMP_TO_EDGE},{name:p.TEXTURE_WRAP_T,value:p.CLAMP_TO_EDGE}],data:{format:p.RGBA,value:false,type:p.UNSIGNED_BYTE,width:0,height:0,border:0}},n||{});var j="textureType"in n?n.textureType=p.get(n.textureType):p.TEXTURE_2D,f="textureTarget"in
n?n.textureTarget=p.get(n.textureTarget):j,d=j==p.TEXTURE_CUBE_MAP,h=m in this.textures,c=h?this.textures[m]:p.createTexture(),i=n.pixelStore,k=n.parameters,l=n.data,r=l.value,w=l.type,s=l.format,A=!!l.value;h||(this.textures[m]=c);p.bindTexture(j,c);h||i.forEach(function(a){a.name=typeof a.name=="string"?p.get(a.name):a.name;p.pixelStorei(a.name,a.value)});if(A)if(d)for(c=0;c<6;++c)(l.width||l.height)&&!r.width&&!r.height?p.texImage2D(f[c],0,s,l.width,l.height,l.border,s,w,r[c]):p.texImage2D(f[c],
0,s,s,w,r[c]);else(l.width||l.height)&&!r.width&&!r.height?p.texImage2D(f,0,s,l.width,l.height,l.border,s,w,r):p.texImage2D(f,0,s,s,w,r);else if(l.width||l.height)p.texImage2D(f,0,s,l.width,l.height,l.border,s,w,null);if(!h)for(c=0;c<k.length;c++){f=k[c];f.name=p.get(f.name);f.value=p.get(f.value);p.texParameteri(j,f.name,f.value);f.generateMipmap&&p.generateMipmap(j)}n.isCube=d;if(A)n.data.value=false;this.textureMemo[m]=n;return this}},setTextures:function(m){for(var n in m)this.setTexture(n,m[n]);
return this},use:function(m){p.useProgram(m.program);this.usedProgram=m;return this}};x.Application=y;(function(){try{var m=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(m.getContext("webgl")||m.getContext("experimental-webgl")))}}catch(n){PhiloGL.hasWebGL=function(){return false}}PhiloGL.hasExtension=function(j){if(!PhiloGL.hasWebGL())return false;var f=document.createElement("canvas");return(f.getContext("webgl")||f.getContext("experimental-webgl")).getExtension(j)}})();
PhiloGL.WebGL=x})();(function(){function y(a){return{get:function(){return this[a]},set:function(b){this[a]=b},configurable:false,enumerable:false}}var x=Math.sqrt,m=Math.sin,n=Math.cos,j=Math.tan,f=Math.PI,d=Array.prototype.slice,h=this.Float32Array,c=function(){if(!h||!h.call)return Array;try{h.call({},10)}catch(a){return Array}return h}(),i=c!=Array,k=function(a,b,g){if(i){h.call(this,3);this[0]=a||0;this[1]=b||0;this[2]=g||0}else this.push(a||0,b||0,g||0);this.typedContainer=new h(3)};k.create=
function(){return new h(3)};k.prototype=Object.create(c.prototype,{$$family:{value:"Vec3"},x:y(0),y:y(1),z:y(2)});var l={setVec3:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},set:function(a,b,g,o){a[0]=b;a[1]=g;a[2]=o;return a},add:function(a,b){return new k(a[0]+b[0],a[1]+b[1],a[2]+b[2])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a},add2:function(a,b,g){a[0]=b[0]+g[0];a[1]=b[1]+g[1];a[2]=b[2]+g[2];return a},sub:function(a,b){return new k(a[0]-b[0],a[1]-b[1],a[2]-b[2])},$sub:function(a,
b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];return a},sub2:function(a,b,g){a[0]=b[0]-g[0];a[1]=b[1]-g[1];a[2]=b[2]-g[2];return a},scale:function(a,b){return new k(a[0]*b,a[1]*b,a[2]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},neg:function(a){return new k(-a[0],-a[1],-a[2])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},unit:function(a){var b=k.norm(a);if(b>0)return k.scale(a,1/b);return k.clone(a)},$unit:function(a){var b=k.norm(a);if(b>0)return k.$scale(a,1/b);return a},cross:function(a,
b){var g=a[0],o=a[1],q=a[2],t=b[0],v=b[1],z=b[2];return new k(o*z-q*v,q*t-g*z,g*v-o*t)},$cross:function(a,b){var g=a[0],o=a[1],q=a[2],t=b[0],v=b[1],z=b[2];a[0]=o*z-q*v;a[1]=q*t-g*z;a[2]=g*v-o*t;return a},distTo:function(a,b){var g=a[0]-b[0],o=a[1]-b[1],q=a[2]-b[2];return x(g*g+o*o+q*q)},distToSq:function(a,b){var g=a[0]-b[0],o=a[1]-b[1],q=a[2]-b[2];return g*g+o*o+q*q},norm:function(a){var b=a[0],g=a[1];a=a[2];return x(b*b+g*g+a*a)},normSq:function(a){var b=a[0],g=a[1];a=a[2];return b*b+g*g+a*a},dot:function(a,
b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},clone:function(a){return a.$$family?new k(a[0],a[1],a[2]):k.setVec3(new h(3),a)},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];return b}},r=k.prototype,w;for(w in l){k[w]=l[w];r[w]=function(a){return function(){var b=d.call(arguments);b.unshift(this);return k[a].apply(k,b)}}(w)}var s=function(a,b,g,o,q,t,v,z,B,C,D,E,G,I,J,H){c.call(this,16);this.length=16;typeof a=="number"?this.set(a,b,g,o,q,t,v,z,B,C,D,E,G,
I,J,H):this.id();this.typedContainer=new h(16)};s.create=function(){return new h(16)};s.prototype=Object.create(c.prototype,{$$family:{value:"Mat4"},n11:y(0),n12:y(4),n13:y(8),n14:y(12),n21:y(1),n22:y(5),n23:y(9),n24:y(13),n31:y(2),n32:y(6),n33:y(10),n34:y(14),n41:y(3),n42:y(7),n43:y(11),n44:y(15)});l={id:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},clone:function(a){return a.$$family?new s(a[0],a[4],a[8],
a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]):new h(a)},set:function(a,b,g,o,q,t,v,z,B,C,D,E,G,I,J,H,F){a[0]=b;a[4]=g;a[8]=o;a[12]=q;a[1]=t;a[5]=v;a[9]=z;a[13]=B;a[2]=C;a[6]=D;a[10]=E;a[14]=G;a[3]=I;a[7]=J;a[11]=H;a[15]=F;return a},mulVec3:function(a,b){var g=k.clone(b);return s.$mulVec3(a,g)},$mulVec3:function(a,b){var g=b[0],o=b[1],q=b[2],t=1/(a[3]*g+a[7]*o+a[11]*q+a[15]);b[0]=(a[0]*g+a[4]*o+a[8]*q+a[12])*t;b[1]=(a[1]*g+a[5]*o+a[9]*q+a[13])*t;b[2]=(a[2]*g+a[6]*o+a[10]*
q+a[14])*t;return b},mulMat42:function(a,b,g){var o=b[0],q=b[1],t=b[2],v=b[3],z=b[4],B=b[5],C=b[6],D=b[7],E=b[8],G=b[9],I=b[10],J=b[11],H=b[12],F=b[13],N=b[14];b=b[15];var K=g[0],L=g[1],P=g[2],Q=g[3],R=g[4],U=g[5],V=g[6],W=g[7],S=g[8],T=g[9],X=g[10],O=g[11],Y=g[12],Z=g[13],$=g[14];g=g[15];a[0]=K*o+L*z+P*E+Q*H;a[1]=K*q+L*B+P*G+Q*F;a[2]=K*t+L*C+P*I+Q*N;a[3]=K*v+L*D+P*J+Q*b;a[4]=R*o+U*z+V*E+W*H;a[5]=R*q+U*B+V*G+W*F;a[6]=R*t+U*C+V*I+W*N;a[7]=R*v+U*D+V*J+W*b;a[8]=S*o+T*z+X*E+O*H;a[9]=S*q+T*B+X*G+O*F;a[10]=
S*t+T*C+X*I+O*N;a[11]=S*v+T*D+X*J+O*b;a[12]=Y*o+Z*z+$*E+g*H;a[13]=Y*q+Z*B+$*G+g*F;a[14]=Y*t+Z*C+$*I+g*N;a[15]=Y*v+Z*D+$*J+g*b;return a},mulMat4:function(a,b){var g=s.clone(a);return s.mulMat42(g,a,b)},$mulMat4:function(a,b){return s.mulMat42(a,a,b)},add:function(a,b){var g=s.clone(a);return s.$add(g,b)},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];a[4]+=b[4];a[5]+=b[5];a[6]+=b[6];a[7]+=b[7];a[8]+=b[8];a[9]+=b[9];a[10]+=b[10];a[11]+=b[11];a[12]+=b[12];a[13]+=b[13];a[14]+=b[14];a[15]+=
b[15];return a},transpose:function(a){a=s.clone(a);return s.$transpose(a)},$transpose:function(a){var b=a[8],g=a[12],o=a[1],q=a[9],t=a[13],v=a[2],z=a[6],B=a[14],C=a[3],D=a[7],E=a[11];a[1]=a[4];a[2]=b;a[3]=g;a[4]=o;a[6]=q;a[7]=t;a[8]=v;a[9]=z;a[11]=B;a[12]=C;a[13]=D;a[14]=E;return a},rotateAxis:function(a,b,g){a=s.clone(a);return s.$rotateAxis(a,b,g)},$rotateAxis:function(a,b,g){var o=m(b),q=n(b),t=1-q,v=g[0],z=g[1],B=g[2];g=v*v*t+q;b=v*z*t+B*o;var C=v*B*t-z*o,D=z*v*t-B*o,E=z*z*t+q,G=z*B*t+v*o,I=v*
B*t+z*o;o=z*B*t-v*o;q=B*B*t+q;t=a[0];v=a[1];z=a[2];B=a[3];var J=a[4],H=a[5],F=a[6],N=a[7],K=a[8],L=a[9],P=a[10],Q=a[11];a[0]=t*g+J*b+K*C;a[1]=v*g+H*b+L*C;a[2]=z*g+F*b+P*C;a[3]=B*g+N*b+Q*C;a[4]=t*D+J*E+K*G;a[5]=v*D+H*E+L*G;a[6]=z*D+F*E+P*G;a[7]=B*D+N*E+Q*G;a[8]=t*I+J*o+K*q;a[9]=v*I+H*o+L*q;a[10]=z*I+F*o+P*q;a[11]=B*I+N*o+Q*q;return a},rotateXYZ:function(a,b,g,o){a=s.clone(a);return s.$rotateXYZ(a,b,g,o)},$rotateXYZ:function(a,b,g,o){var q=a[0],t=a[1],v=a[2],z=a[3],B=a[4],C=a[5],D=a[6],E=a[7],G=a[8],
I=a[9],J=a[10],H=a[11],F=n(b),N=n(g),K=n(o);b=m(b);var L=m(g),P=m(o);o=N*K;g=-F*P+b*L*K;var Q=b*P+F*L*K,R=N*P,U=F*K+b*L*P;K=-b*K+F*L*P;L=-L;b*=N;F*=N;a[0]=q*o+B*R+G*L;a[1]=t*o+C*R+I*L;a[2]=v*o+D*R+J*L;a[3]=z*o+E*R+H*L;a[4]=q*g+B*U+G*b;a[5]=t*g+C*U+I*b;a[6]=v*g+D*U+J*b;a[7]=z*g+E*U+H*b;a[8]=q*Q+B*K+G*F;a[9]=t*Q+C*K+I*F;a[10]=v*Q+D*K+J*F;a[11]=z*Q+E*K+H*F;return a},translate:function(a,b,g,o){a=s.clone(a);return s.$translate(a,b,g,o)},$translate:function(a,b,g,o){a[12]=a[0]*b+a[4]*g+a[8]*o+a[12];a[13]=
a[1]*b+a[5]*g+a[9]*o+a[13];a[14]=a[2]*b+a[6]*g+a[10]*o+a[14];a[15]=a[3]*b+a[7]*g+a[11]*o+a[15];return a},scale:function(a,b,g,o){a=s.clone(a);return s.$scale(a,b,g,o)},$scale:function(a,b,g,o){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;a[4]*=g;a[5]*=g;a[6]*=g;a[7]*=g;a[8]*=o;a[9]*=o;a[10]*=o;a[11]*=o;return a},invert:function(a){a=s.clone(a);return s.$invert(a)},$invert:function(a){var b=a[0],g=a[1],o=a[2],q=a[3],t=a[4],v=a[5],z=a[6],B=a[7],C=a[8],D=a[9],E=a[10],G=a[11],I=a[12],J=a[13],H=a[14],F=a[15],N=b*v-
g*t,K=b*z-o*t,L=b*B-q*t,P=g*z-o*v,Q=g*B-q*v,R=o*B-q*z,U=C*J-D*I,V=C*H-E*I,W=C*F-G*I,S=D*H-E*J,T=D*F-G*J,X=E*F-G*H,O=1/(N*X-K*T+L*S+P*W-Q*V+R*U);a[0]=(+v*X-z*T+B*S)*O;a[1]=(-g*X+o*T-q*S)*O;a[2]=(+J*R-H*Q+F*P)*O;a[3]=(-D*R+E*Q-G*P)*O;a[4]=(-t*X+z*W-B*V)*O;a[5]=(+b*X-o*W+q*V)*O;a[6]=(-I*R+H*L-F*K)*O;a[7]=(+C*R-E*L+G*K)*O;a[8]=(+t*T-v*W+B*U)*O;a[9]=(-b*T+g*W-q*U)*O;a[10]=(+I*Q-J*L+F*N)*O;a[11]=(-C*Q+D*L-G*N)*O;a[12]=(-t*S+v*V-z*U)*O;a[13]=(+b*S-g*V+o*U)*O;a[14]=(-I*P+J*K-H*N)*O;a[15]=(+C*P-D*K+E*N)*O;
return a},lookAt:function(a,b,g,o){g=k.sub(b,g);g.$unit();o=k.cross(o,g);o.$unit();var q=k.cross(g,o);q.$unit();return s.set(a,o[0],o[1],o[2],-o.dot(b),q[0],q[1],q[2],-q.dot(b),g[0],g[1],g[2],-g.dot(b),0,0,0,1)},frustum:function(a,b,g,o,q,t,v){var z=g-b,B=q-o,C=v-t;a[0]=t*2/z;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=t*2/B;a[6]=0;a[7]=0;a[8]=(g+b)/z;a[9]=(q+o)/B;a[10]=-(v+t)/C;a[11]=-1;a[12]=0;a[13]=0;a[14]=-(v*t*2)/C;a[15]=0;return a},perspective:function(a,b,g,o,q){b=o*j(b*f/360);var t=-b;return s.frustum(a,
t*g,b*g,t,b,o,q)},ortho:function(a,b,g,o,q,t,v){var z=g-b,B=o-q,C=v-t;a[0]=2/z;a[4]=0;a[8]=0;a[12]=-((g+b)/z);a[1]=0;a[5]=2/B;a[9]=0;a[13]=-((o+q)/B);a[2]=0;a[6]=0;a[10]=-2/C;a[14]=-((v+t)/C);a[3]=0;a[7]=0;a[11]=0;a[15]=1;return a},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b}};r=s.prototype;for(w in l){s[w]=
l[w];r[w]=function(a){return function(){var b=d.call(arguments);b.unshift(this);return s[a].apply(s,b)}}(w)}var A=function(a,b,g,o){c.call(this,4);this[0]=a||0;this[1]=b||0;this[2]=g||0;this[3]=o||0;this.typedContainer=new h(4)};A.create=function(){return new h(4)};l={setQuat:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},set:function(a,b,g,o,q){a[0]=b||0;a[1]=g||0;a[2]=o||0;a[3]=q||0;return a},clone:function(a){return a.$$family?new A(a[0],a[1],a[2],a[3]):A.setQuat(new h(4),a)},
neg:function(a){return new A(-a[0],-a[1],-a[2],-a[3])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},add:function(a,b){return new A(a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];return a},sub:function(a,b){return new A(a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];a[3]-=b[3];return a},scale:function(a,b){return new A(a[0]*b,a[1]*b,a[2]*b,a[3]*b)},$scale:function(a,b){a[0]*=
b;a[1]*=b;a[2]*=b;a[3]*=b;return a},mulQuat:function(a,b){var g=a[0],o=a[1],q=a[2],t=a[3],v=b[0],z=b[1],B=b[2],C=b[3];return new A(t*v+g*C+o*B-q*z,t*z+o*C+q*v-g*B,t*B+q*C+g*z-o*v,t*C-g*v-o*z-q*B)},$mulQuat:function(a,b){var g=a[0],o=a[1],q=a[2],t=a[3],v=b[0],z=b[1],B=b[2],C=b[3];a[0]=t*v+g*C+o*B-q*z;a[1]=t*z+o*C+q*v-g*B;a[2]=t*B+q*C+g*z-o*v;a[3]=t*C-g*v-o*z-q*B;return a},divQuat:function(a,b){var g=a[0],o=a[1],q=a[2],t=a[3],v=b[0],z=b[1],B=b[2],C=b[3],D=1/(C*C+v*v+z*z+B*B);return new A((g*C-t*v-o*
B+q*z)*D,(g*B-t*z+o*C-q*v)*D,(o*v+q*C-t*B-g*z)*D,(t*C+g*v+o*z+q*B)*D)},$divQuat:function(a,b){var g=a[0],o=a[1],q=a[2],t=a[3],v=b[0],z=b[1],B=b[2],C=b[3],D=1/(C*C+v*v+z*z+B*B);a[0]=(g*C-t*v-o*B+q*z)*D;a[1]=(g*B-t*z+o*C-q*v)*D;a[2]=(o*v+q*C-t*B-g*z)*D;a[3]=(t*C+g*v+o*z+q*B)*D;return a},invert:function(a){var b=a[0],g=a[1],o=a[2];a=a[3];var q=1/(b*b+g*g+o*o+a*a);return new A(-b*q,-g*q,-o*q,a*q)},$invert:function(a){var b=a[0],g=a[1],o=a[2],q=a[3],t=1/(b*b+g*g+o*o+q*q);a[0]=-b*t;a[1]=-g*t;a[2]=-o*t;
a[3]=q*t;return a},norm:function(a){var b=a[0],g=a[1],o=a[2];a=a[3];return x(b*b+g*g+o*o+a*a)},normSq:function(a){var b=a[0],g=a[1],o=a[2];a=a[3];return b*b+g*g+o*o+a*a},unit:function(a){return A.scale(a,1/A.norm(a))},$unit:function(a){return A.$scale(a,1/A.norm(a))},conjugate:function(a){return new A(-a[0],-a[1],-a[2],a[3])},$conjugate:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a}};r=A.prototype={};for(w in l){A[w]=l[w];r[w]=function(a){return function(){var b=d.call(arguments);b.unshift(this);
return A[a].apply(A,b)}}(w)}k.fromQuat=function(a){return new k(a[0],a[1],a[2])};A.fromVec3=function(a,b){return new A(a[0],a[1],a[2],b||0)};A.fromMat4=function(a){var b,g,o;if(a[0]>a[5]&&a[0]>a[10]){b=0;g=1;o=2}else if(a[5]>a[0]&&a[5]>a[10]){b=1;g=2;o=0}else{b=2;g=0;o=1}var q=x(1+a[b*5]-a[g*5]-a[o*5]),t=new A;t[b]=0.5*q;t[g]=0.5*(a["n"+g+""+b]+a["n"+b+""+g])/q;t[o]=0.5*(a["n"+b+""+o]+a["n"+o+""+b])/q;t[3]=0.5*(a["n"+g+""+o]-a["n"+o+""+g])/q;return t};A.fromXRotation=function(a){return new A(m(a/
2),0,0,n(a/2))};A.fromYRotation=function(a){return new A(0,m(a/2),0,n(a/2))};A.fromZRotation=function(a){return new A(0,0,m(a/2),n(a/2))};A.fromAxisRotation=function(a,b){var g=a[0],o=a[1],q=a[2],t=1/x(g*g+o*o+q*q),v=m(b/2),z=n(b/2);return new A(v*g*t,v*o*t,v*q*t,z)};s.fromQuat=function(a){var b=a[3],g=a[0],o=a[1];a=a[2];return new s(b*b+g*g-o*o-a*a,2*g*o-2*b*a,2*g*a+2*b*o,0,2*g*o+2*b*a,b*b-g*g+o*o-a*a,2*o*a-2*b*g,0,2*g*a-2*b*o,2*o*a+2*b*g,b*b-g*g-o*o+a*a,0,0,0,0,1)};PhiloGL.Vec3=k;PhiloGL.Mat4=s;
PhiloGL.Quat=A})();(function(){function y(f){return f!==true?f:false}var x=function(f){f=f.getBoundingClientRect();return{x:f.left,y:f.top,bbox:f}},m={get:function(f,d){return f||(d||window).event},getWheel:function(f){return f.wheelDelta?f.wheelDelta/120:-(f.detail||0)/3},getKey:function(f){var d=f.which||f.keyCode,h;a:{h=j.Keys;for(var c in h)if(h[c]==d){h=c;break a}h=void 0}c=d-111;if(c>0&&c<13)h="f"+c;h=h||String.fromCharCode(d).toLowerCase();return{code:d,key:h,shift:f.shiftKey,control:f.ctrlKey,
alt:f.altKey,meta:f.metaKey}},isRightClick:function(f){return f.which==3||f.button==2},getPos:function(f,d){d=d||window;f=f||d.event;var h=d.document,c;h=h.documentElement||h.body;if(f.touches&&f.touches.length){c=[];for(var i=0,k=f.touches.length,l;i<k;++i){l=f.touches[i];c.push({x:l.pageX||l.clientX+h.scrollLeft,y:l.pageY||l.clientY+h.scrollTop})}return c}return[{x:f.pageX||f.clientX+h.scrollLeft,y:f.pageY||f.clientY+h.scrollTop}]},stop:function(f){f.stopPropagation&&f.stopPropagation();f.cancelBubble=
true;if(f.preventDefault)f.preventDefault();else f.returnValue=false}},n=function(f,d){var h=f.canvas;this.scene=f.scene;this.domElem=h;this.pos=x(h);this.opt=this.callbacks=d;this.size={width:h.width||h.offsetWidth,height:h.height||h.offsetHeight};this.attachEvents()};n.prototype={hovered:false,pressed:false,touched:false,touchedLastPosition:{x:0,y:0},touchMoved:false,moved:false,attachEvents:function(){var f=this.domElem,d=this.opt,h=this;if(d.disableContextMenu)f.oncontextmenu=function(){return false};
if(d.enableMouse){["mouseup","mousedown","mousemove","mouseover","mouseout"].forEach(function(i){f.addEventListener(i,function(k,l){h[i](h.eventInfo(i,k,l))},false)});var c="";c=!document.getBoxObjectFor&&window.mozInnerScreenX==null?"mousewheel":"DOMMouseScroll";f.addEventListener(c,function(i,k){h.mousewheel(h.eventInfo("mousewheel",i,k))},false)}d.enableTouch&&["touchstart","touchmove","touchend"].forEach(function(i){f.addEventListener(i,function(k,l){h[i](h.eventInfo(i,k,l))},false)});d.enableKeyboard&&
["keydown","keyup"].forEach(function(i){document.addEventListener(i,function(k,l){h[i](h.eventInfo(i,k,l))},false)})},eventInfo:function(f,d,h){var c=this.domElem,i=this.scene,k=this.opt,l=this.getSize(),r=k.relative,w=k.centerOrigin,s=k.cachePosition&&this.pos||x(c),A=m.get(d,h);d=m.getPos(d,h);var a={x:d[0].x,y:d[0].y};h={};for(var b,g=0,o=d.length;g<o;++g){c=d[g].x;b=d[g].y;if(r){c-=s.x;b-=s.y;if(w){c-=l.width/2;b-=l.height/2;b*=-1}}d[g].x=c;d[g].y=b}switch(f){case "mousewheel":h.wheel=m.getWheel(A);
break;case "keydown":case "keyup":u.extend(h,m.getKey(A));break;case "mouseup":h.isRightClick=m.isRightClick(A)}var q;u.extend(h,{x:d[0].x,y:d[0].y,posArray:d,cache:false,stop:function(){m.stop(A)},getTarget:function(){if(q)return q;return q=k.picking&&i.pick(a.x-s.x,a.y-s.y)||false}});h.event=A;return h},getSize:function(){if(this.cacheSize)return this.size;var f=this.domElem;return{width:f.width||f.offsetWidth,height:f.height||f.offsetHeight}},mouseup:function(f){if(!this.moved)if(f.isRightClick)this.callbacks.onRightClick(f,
this.hovered);else this.callbacks.onClick(f,y(this.pressed));if(this.pressed){if(this.moved)this.callbacks.onDragEnd(f,y(this.pressed));else this.callbacks.onDragCancel(f,y(this.pressed));this.pressed=this.moved=false}},mouseout:function(f){for(var d=f.relatedTarget,h=this.domElem;d&&d.parentNode;){if(h==d.parentNode)return;d=d.parentNode}if(this.hovered){this.callbacks.onMouseLeave(f,this.hovered);this.hovered=false}if(this.pressed&&this.moved){this.callbacks.onDragEnd(f);this.pressed=this.moved=
false}},mouseover:function(){},mousemove:function(f){if(this.pressed){this.moved=true;this.callbacks.onDragMove(f,y(this.pressed))}else{if(this.hovered){var d=y(f.getTarget());if(!d||d.hash!=this.hash){this.callbacks.onMouseLeave(f,this.hovered);if(this.hash=this.hovered=d){this.hash=d.hash;this.callbacks.onMouseEnter(f,this.hovered)}}else this.callbacks.onMouseMove(f,this.hovered)}else if(this.hash=this.hovered=y(f.getTarget())){this.hash=this.hovered.hash;this.callbacks.onMouseEnter(f,this.hovered)}if(!this.opt.picking)this.callbacks.onMouseMove(f)}},
mousewheel:function(f){this.callbacks.onMouseWheel(f)},mousedown:function(f){this.pressed=f.getTarget();this.callbacks.onDragStart(f,y(this.pressed))},touchstart:function(f){this.touched=f.getTarget();this.touchedLastPosition={x:f.x,y:f.y};this.callbacks.onTouchStart(f,y(this.touched))},touchmove:function(f){if(this.touched){this.touchMoved=true;this.callbacks.onTouchMove(f,y(this.touched))}},touchend:function(f){if(this.touched){if(this.touchMoved)this.callbacks.onTouchEnd(f,y(this.touched));else{f.x=
isNaN(f.x)?this.touchedLastPosition.x:f.x;f.y=isNaN(f.y)?this.touchedLastPosition.y:f.y;this.callbacks.onTap(f,y(this.touched));this.callbacks.onTouchCancel(f,y(this.touched))}this.touched=this.touchMoved=false}},keydown:function(f){this.callbacks.onKeyDown(f)},keyup:function(f){this.callbacks.onKeyUp(f)}};var j={};j.create=function(f,d){d=u.extend({cachePosition:true,cacheSize:true,relative:true,centerOrigin:true,disableContextMenu:true,bind:false,picking:false,lazyPicking:false,enableTouch:true,
enableMouse:true,enableKeyboard:true,onClick:u.empty,onRightClick:u.empty,onDragStart:u.empty,onDragMove:u.empty,onDragEnd:u.empty,onDragCancel:u.empty,onTouchStart:u.empty,onTouchMove:u.empty,onTouchEnd:u.empty,onTouchCancel:u.empty,onTap:u.empty,onMouseMove:u.empty,onMouseEnter:u.empty,onMouseLeave:u.empty,onMouseWheel:u.empty,onKeyDown:u.empty,onKeyUp:u.empty},d||{});var h=d.bind;if(h)for(var c in d)c.match(/^on[a-zA-Z0-9]+$/)&&function(i,k){d[i]=function(){return k.apply(h,Array.prototype.slice.call(arguments))}}(c,
d[c]);new n(f,d);f.events=d};j.Keys={enter:13,up:38,down:40,left:37,right:39,esc:27,space:32,backspace:8,tab:9,"delete":46};PhiloGL.Events=j})();(function(){function y(d,h){return u.merge(h||{},d.length==2?{vs:d[0],fs:d[1]}:d[0]||{})}var x=function(d,h,c){var i=d.createShader(c);if(i==null)throw"Error creating the shader with shader type: "+c;d.shaderSource(i,h);d.compileShader(i);if(!d.getShaderParameter(i,d.COMPILE_STATUS)){h=d.getShaderInfoLog(i);d.deleteShader(i);throw"Error while compiling the shader "+
h;}return i},m=function(d){var h=d.lastIndexOf("/");return h=="/"?"./":d.substr(0,h+1)},n=function(d,h,c,i,k){k=k||{};var l;if(l=h.match(/#include "(.*?)"/)){var r=PhiloGL.IO.XHR,w=m(d)+l[1];k[w]&&i("Recursive include");(new r({url:w,noCache:true,onError:function(s){i("Load included file `"+w+"` failed: Code "+s)},onSuccess:function(s){k[w]=true;return n(w,s,function(A){delete k[w];h=h.replace(/#include ".*?"/,A);h=h.replace(/\sHAS_EXTENSION\s*\(\s*([A-Za-z_\-0-9]+)\s*\)/g,function(a,b){return p.getExtension(b)?
" 1 ":" 0 "});return n(w,h,c,i,k)},i,k)}})).send();return null}else return c(h)},j=function(d,h,c){var i=p.getUniformLocation(d,h.name);d=h.type;var k=false,l=true,r,w;if(h.size>1&&c)switch(d){case p.FLOAT:r=p.uniform1fv;w=Float32Array;l=false;break;case p.INT:case p.BOOL:case p.SAMPLER_2D:case p.SAMPLER_CUBE:r=p.uniform1iv;w=Uint16Array;l=false}if(l)switch(d){case p.FLOAT:r=p.uniform1f;break;case p.FLOAT_VEC2:r=p.uniform2fv;w=c?Float32Array:new Float32Array(2);break;case p.FLOAT_VEC3:r=p.uniform3fv;
w=c?Float32Array:new Float32Array(3);break;case p.FLOAT_VEC4:r=p.uniform4fv;w=c?Float32Array:new Float32Array(4);break;case p.INT:case p.BOOL:case p.SAMPLER_2D:case p.SAMPLER_CUBE:r=p.uniform1i;break;case p.INT_VEC2:case p.BOOL_VEC2:r=p.uniform2iv;w=c?Uint16Array:new Uint16Array(2);break;case p.INT_VEC3:case p.BOOL_VEC3:r=p.uniform3iv;w=c?Uint16Array:new Uint16Array(3);break;case p.INT_VEC4:case p.BOOL_VEC4:r=p.uniform4iv;w=c?Uint16Array:new Uint16Array(4);break;case p.FLOAT_MAT2:k=true;r=p.uniformMatrix2fv;
break;case p.FLOAT_MAT3:k=true;r=p.uniformMatrix3fv;break;case p.FLOAT_MAT4:k=true;r=p.uniformMatrix4fv}r=r.bind(p);return c&&w?function(s){r(i,new w(s))}:k?function(s){r(i,false,s.toFloat32Array())}:w?function(s){w.set(s.toFloat32Array?s.toFloat32Array():s);r(i,w)}:function(s){r(i,s)};throw"Unknown type: "+d;},f=function(d,h){var c=p,i=c.createProgram();c.attachShader(i,x(c,d,c.VERTEX_SHADER));c.attachShader(i,x(c,h,c.FRAGMENT_SHADER));c.linkProgram(i);if(!c.getProgramParameter(i,c.LINK_STATUS))throw"Error linking the shader: "+
c.getProgramInfoLog(i);if(!i)return false;c={};for(var k={},l,r,w=p.getProgramParameter(i,p.ACTIVE_ATTRIBUTES),s=0;s<w;s++){l=p.getActiveAttrib(i,s);r=l.name;l=p.getAttribLocation(i,l.name);c[r]=l}w=p.getProgramParameter(i,p.ACTIVE_UNIFORMS);for(s=0;s<w;s++){l=p.getActiveUniform(i,s);r=l.name;r=r[r.length-1]=="]"?r.substr(0,r.length-3):r;k[r]=j(i,l,l.name!=r)}this.program=i;this.attributes=c;this.attributeEnabled={};this.uniforms=k};f.prototype={$$family:"program",setUniform:function(d,h){if(this.uniforms[d])this.uniforms[d](h);
return this},setUniforms:function(d){for(var h in d)this.setUniform(h,d[h]);return this}};["setBuffer","setBuffers","use"].forEach(function(d){f.prototype[d]=function(){var h=Array.prototype.slice.call(arguments);h.unshift(this);M[d].apply(M,h);return this}});["setFrameBuffer","setFrameBuffers","setRenderBuffer","setRenderBuffers","setTexture","setTextures"].forEach(function(d){f.prototype[d]=function(){M[d].apply(M,arguments);return this}});f.fromShaderIds=function(){var d=y(arguments),h=u(d.vs),
c=u(d.fs);return n(d.path,h.innerHTML,function(i){return n(d.path,c.innerHTML,function(k){d.onSuccess(new f(i,k),d)})})};f.fromShaderSources=function(){var d=y(arguments,{path:"./"});return n(d.path,d.vs,function(h){return n(d.path,d.fs,function(c){try{var i=new f(h,c);if(d.onSuccess)d.onSuccess(i,d);else return i}catch(k){if(d.onError)d.onError(k,d);else throw k;}})})};f.fromDefaultShaders=function(d){d=d||{};var h=d.fs||"Default",c=PhiloGL.Shaders;d.vs=c.Vertex[d.vs||"Default"];d.fs=c.Fragment[h];
return PhiloGL.Program.fromShaderSources(d)};f.fromShaderURIs=function(d){d=u.merge({path:"",vs:"",fs:"",noCache:false,onSuccess:u.empty,onError:u.empty},d||{});var h=d.path+d.vs,c=d.path+d.fs;(new PhiloGL.IO.XHR.Group({urls:[h,c],noCache:d.noCache,onError:function(i){d.onError(i)},onComplete:function(i){try{return n(h,i[0],function(l){return n(c,i[1],function(r){d.vs=l;d.fs=r;return f.fromShaderSources(d)},d.onError)},d.onError)}catch(k){d.onError(k,d)}}})).send()};PhiloGL.Program=f})();(function(){var y=
{},x=function(j){this.opt=j=u.merge({url:"http://philogljs.org/",method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false,onProgress:u.empty,onSuccess:u.empty,onError:u.empty,onAbort:u.empty,onComplete:u.empty},j||{});this.initXHR()};x.State={};["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(j,f){x.State[j]=f});x.prototype={initXHR:function(){var j=this.req=new XMLHttpRequest,f=this;["Progress","Error","Abort","Load"].forEach(function(d){if(j.addEventListener)j.addEventListener(d.toLowerCase(),
function(h){f["handle"+d](h)},false);else j["on"+d.toLowerCase()]=function(h){f["handle"+d](h)}})},send:function(j){var f=this.req,d=this.opt,h=d.async;if(d.noCache)d.url+=(d.url.indexOf("?")>=0?"&":"?")+u.uid();f.open(d.method,d.url,h);if(d.responseType)f.responseType=d.responseType;if(h)f.onreadystatechange=function(){if(f.readyState==x.State.COMPLETED)if(f.status==200)d.onSuccess(f.responseType?f.response:f.responseText);else d.onError(f.status)};d.sendAsBinary?f.sendAsBinary(j||d.body||null):
f.send(j||d.body||null);if(!h)if(f.status==200)d.onSuccess(f.responseType?f.response:f.responseText);else d.onError(f.status)},setRequestHeader:function(j,f){this.req.setRequestHeader(j,f);return this},handleProgress:function(j){if(j.lengthComputable)this.opt.onProgress(j,Math.round(j.loaded/j.total*100));else this.opt.onProgress(j,-1)},handleError:function(j){this.opt.onError(j)},handleAbort:function(){this.opt.onAbort(e)},handleLoad:function(j){this.opt.onComplete(j)}};x.Group=function(j){function f(k){return function(l){--c;
j.onError(l,k);if(!c)j.onComplete(i)}}function d(k){return function(l){--c;i[k]=l;j.onSuccess(l,k);if(!c)j.onComplete(i)}}j=u.merge({urls:[],onError:u.empty,onSuccess:u.empty,onComplete:u.empty,method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false},j||{});var h=u.splat(j.urls),c=h.length,i=Array(c);this.reqs=h.map(function(k,l){return new x({url:k,method:j.method,async:j.async,noCache:j.noCache,sendAsBinary:j.sendAsBinary,responseType:j.responseType,body:j.body,onError:f(l),
onSuccess:d(l)})})};x.Group.prototype={send:function(){for(var j=0,f=this.reqs,d=f.length;j<d;++j)f[j].send()}};var m=function(j){j=u.merge({url:"http://philogljs.org/",data:{},noCache:false,onComplete:u.empty,callbackKey:"callback"},j||{});var f=m.counter++,d=[],h;for(h in j.data)d.push(h+"="+j.data[h]);d=d.join("&");if(j.noCache)d+=(d.indexOf("?")>=0?"&":"?")+u.uid();d=j.url+(j.url.indexOf("?")>-1?"&":"?")+j.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+f+(d.length>0?"&"+d:"");var c=document.createElement("script");
c.type="text/javascript";c.src=d;m.requests["request_"+f]=function(i){j.onComplete(i);c.parentNode&&c.parentNode.removeChild(c);c.clearAttributes&&c.clearAttributes()};document.getElementsByTagName("head")[0].appendChild(c)};m.counter=0;m.requests={};var n=function(j){j=u.merge({src:[],noCache:false,onProgress:u.empty,onComplete:u.empty},j||{});var f=0,d=j.src.length,h=function(){j.onProgress(Math.round(++f/d*100));if(f==d)j.onComplete(l)},c=function(){if(++f==d)j.onComplete(l)},i=j.noCache,k=u.uid(),
l=j.src.map(function(r,w){var s=new Image;s.index=w;s.onload=h;s.onerror=c;s.src=r+(i?(r.indexOf("?")>=0?"&":"?")+k:"");return s});return l};y.XHR=x;y.JSONP=m;y.Images=n;y.Textures=function(j){j=u.merge({src:[],noCache:false,onComplete:u.empty},j||{});n({src:j.src,noCache:j.noCache,onComplete:function(f){var d={};f.forEach(function(h,c){d[j.id&&j.id[c]||j.src&&j.src[c]]=u.merge({data:{value:h}},j)});M.setTextures(d);j.onComplete()}})};PhiloGL.IO=y})();(function(){var y=PhiloGL.Vec3,x=PhiloGL.Mat4,
m=function(n,j,f,d,h){h=h||{};var c=h.position,i=h.target,k=h.up;this.type=h.type?h.type:"perspective";this.fov=n;this.near=f;this.far=d;this.aspect=j;this.position=c&&new y(c.x,c.y,c.z)||new y;this.target=i&&new y(i.x,i.y,i.z)||new y;this.up=k&&new y(k.x,k.y,k.z)||new y(0,1,0);if(this.type=="perspective")this.projection=(new x).perspective(n,j,f,d);else{n=f*Math.tan(n*Math.PI/360);h=-n;this.projection=(new x).ortho(h*j,n*j,h,n,f,d)}this.view=new x};m.prototype={update:function(){if(this.type=="perspective")this.projection=
(new x).perspective(this.fov,this.aspect,this.near,this.far);else{var n=this.near*Math.tan(this.fov*Math.PI/360),j=-n,f=j*this.aspect,d=n*this.aspect;this.projection=(new x).ortho(f,d,j,n,this.near,this.far)}this.view.lookAt(this.position,this.target,this.up)},setStatus:function(n){var j=this.position,f=this.view,d=this.projection,h=f.mulMat4(d),c=h.invert();n.setUniforms({cameraPosition:[j.x,j.y,j.z],projectionMatrix:d,viewMatrix:f,viewProjectionMatrix:h,viewInverseMatrix:f.invert(),viewProjectionInverseMatrix:c})}};
PhiloGL.Camera=m})();(function(){function y(c,i){if(c&&c.length<i){for(var k=c[0],l=c[1],r=c[2],w=c[3],s=[k,l,r,w],A=i/c.length,a;--A;){a=A*4;s[a]=k;s[a+1]=l;s[a+2]=r;s[a+3]=w}return new Float32Array(s)}else return c}var x=PhiloGL.Vec3,m=PhiloGL.Mat4,n=Math.cos,j=Math.sin,f=Math.PI,d=Array.prototype.slice,h={attributeMap:{position:"vertices",normal:"normals",pickingColor:"pickingColors",colors:"color"}};h.Model=function(c){c=c||{};this.id=c.id||u.uid();this.pickable=!!c.pickable;this.pick=c.pick||
function(){return false};this.vertices=c.vertices;this.normals=c.normals;this.textures=c.textures&&u.splat(c.textures);this.colors=c.colors;this.indices=c.indices;this.shininess=c.shininess||0;this.reflection=c.reflection||0;this.refraction=c.refraction||0;if(c.pickingColors)this.pickingColors=c.pickingColors;if(c.texCoords)this.texCoords=c.texCoords;this.uniforms=c.uniforms||{};this.attributes=c.attributes||{};this.render=c.render;this.drawType=c.drawType||"TRIANGLES";this.display="display"in c?
c.display:true;this.onBeforeRender=c.onBeforeRender||u.empty;this.onAfterRender=c.onAfterRender||u.empty;if(c.program)this.program=c.program;this.position=new x;this.rotation=new x;this.scale=new x(1,1,1);this.matrix=new m;c.computeCentroids&&this.computeCentroids();c.computeNormals&&this.computeNormals()};h.Model.prototype=Object.create(null,{hash:{get:function(){return this.id+" "+this.$pickingIndex}},vertices:{set:function(c){if(c){var i=c.length;if(c.BYTES_PER_ELEMENT)this.$vertices=c;else if(this.$verticesLength==
i)this.$vertices.set(c);else this.$vertices=new Float32Array(c);this.$verticesLength=i}else{delete this.$vertices;delete this.$verticesLength}},get:function(){return this.$vertices}},normals:{set:function(c){if(c){var i=c.length;if(c.BYTES_PER_ELEMENT)this.$normals=c;else if(this.$normalsLength==i)this.$normals.set(c);else this.$normals=new Float32Array(c);this.$normalsLength=i}else{delete this.$normals;delete this.$normalsLength}},get:function(){return this.$normals}},colors:{set:function(c){if(c){var i=
c.length;if(c.BYTES_PER_ELEMENT)this.$colors=c;else if(this.$colorsLength==i)this.$colors.set(c);else this.$colors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=i)this.$colors=y(d.call(this.$colors),this.$verticesLength/3*4);this.$colorsLength=this.$colors.length}else{delete this.$colors;delete this.$colorsLength}},get:function(){return this.$colors}},pickingColors:{set:function(c){if(c){var i=c.length;if(c.BYTES_PER_ELEMENT)this.$pickingColors=c;else if(this.$pickingColorsLength==
i)this.$pickingColors.set(c);else this.$pickingColors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=i)this.$pickingColors=y(d.call(this.$pickingColors),this.$verticesLength/3*4);this.$pickingColorsLength=this.$pickingColors.length}else{delete this.$pickingColors;delete this.$pickingColorsLength}},get:function(){return this.$pickingColors}},texCoords:{set:function(c){if(c)if(u.type(c)=="object"){var i={},k;for(k in c){var l=c[k];i[k]=l.BYTES_PER_ELEMENT?l:new Float32Array(l)}this.$texCoords=
i}else{i=c.length;if(c.BYTES_PER_ELEMENT)this.$texCoords=c;else if(this.$texCoordsLength==i)this.$texCoords.set(c);else this.$texCoords=new Float32Array(c);this.$texCoordsLength=i}else{delete this.$texCoords;delete this.$texCoordsLength}},get:function(){return this.$texCoords}},indices:{set:function(c){if(c){var i=c.length;if(c.BYTES_PER_ELEMENT)this.$indices=c;else if(this.$indicesLength==i)this.$indices.set(c);else this.$indices=new Uint16Array(c);this.$indicesLength=i}else{delete this.$indices;
delete this.$indicesLength}},get:function(){return this.$indices}}});u.extend(h.Model.prototype,{$$family:"model",update:function(){var c=this.matrix,i=this.position,k=this.rotation,l=this.scale;c.id();c.$translate(i.x,i.y,i.z);c.$rotateXYZ(k.x,k.y,k.z);c.$scale(l.x,l.y,l.z)},computeCentroids:function(){var c=this.vertices,i=[];this.faces.forEach(function(k){var l=[0,0,0],r=0;k.forEach(function(w){w=c[w];l[0]+=w[0];l[1]+=w[1];l[2]+=w[2];r++});l[0]/=r;l[1]/=r;l[2]/=r;i.push(l)});this.centroids=i},
computeNormals:function(){var c=this.vertices,i=[];this.faces.forEach(function(k){var l=c[k[0]],r=c[k[1]];k=c[k[2]];l={x:l[0]-r[0],y:l[1]-r[1],z:l[2]-r[2]};x.$cross(l,{x:k[0]-r[0],y:k[1]-r[1],z:k[1]-r[2]});x.norm(l)>1.0E-6&&x.unit(l);i.push([l.x,l.y,l.z])});this.normals=i}});u.extend(h.Model.prototype,{setUniforms:function(c){c.setUniforms(this.uniforms)},setAttributes:function(c){var i=this.attributes,k;for(k in i){var l=i[k],r=this.id+"-"+k;if(Object.keys(l).length){l.attribute=k;c.setBuffer(r,
l);delete l.value}else c.setBuffer(r,true)}},setVertices:function(c){if(this.$vertices)this.dynamic?c.setBuffer("position-"+this.id,{attribute:"position",value:this.$vertices,size:3}):c.setBuffer("position-"+this.id)},setNormals:function(c){if(this.$normals)this.dynamic?c.setBuffer("normal-"+this.id,{attribute:"normal",value:this.$normals,size:3}):c.setBuffer("normal-"+this.id)},setIndices:function(c){if(this.$indices)this.dynamic?c.setBuffer("indices-"+this.id,{bufferType:p.ELEMENT_ARRAY_BUFFER,
drawType:p.STATIC_DRAW,value:this.$indices,size:1}):c.setBuffer("indices-"+this.id)},setPickingColors:function(c){if(this.$pickingColors)this.dynamic?c.setBuffer("pickingColor-"+this.id,{attribute:"pickingColor",value:this.$pickingColors,size:4}):c.setBuffer("pickingColor-"+this.id)},setColors:function(c){if(this.$colors)this.dynamic?c.setBuffer("color-"+this.id,{attribute:"color",value:this.$colors,size:4}):c.setBuffer("color-"+this.id)},setTexCoords:function(c){if(this.$texCoords){var i=this.id,
k,l,r,w;if(this.dynamic)if(u.type(this.$texCoords)=="object"){k=0;l=this.textures;for(r=l.length;k<r;k++){w=l[k];c.setBuffer("texCoord-"+k+"-"+i,{attribute:"texCoord"+(k+1),value:this.$texCoords[w],size:2})}}else c.setBuffer("texCoord-"+i,{attribute:"texCoord1",value:this.$texCoords,size:2});else if(u.type(this.$texCoords)=="object"){k=0;l=this.textures;for(r=l.length;k<r;k++)c.setBuffer("texCoord-"+k+"-"+i)}else c.setBuffer("texCoord-"+i)}},setTextures:function(c){this.textures=this.textures?u.splat(this.textures):
[];for(var i=0,k=this.textures,l=k.length,r=PhiloGL.Scene.MAX_TEXTURES;i<r;i++){if(i<l)if(M.textureMemo[k[i]].isCube){c.setUniform("hasTextureCube"+(i+1),true);c.setTexture(k[i],p["TEXTURE"+(i+5)])}else{c.setUniform("hasTexture"+(i+1),true);c.setTexture(k[i],p["TEXTURE"+i])}else{c.setUniform("hasTextureCube"+(i+1),false);c.setUniform("hasTexture"+(i+1),false)}c.setUniform("sampler"+(i+1),i);c.setUniform("samplerCube"+(i+1),i+5)}},setState:function(c){this.setUniforms(c);this.setAttributes(c);this.setVertices(c);
this.setColors(c);this.setPickingColors(c);this.setNormals(c);this.setTextures(c);this.setTexCoords(c);this.setIndices(c)},unsetState:function(c){c=c.attributes;p.bindBuffer(p.ARRAY_BUFFER,null);p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,null);for(var i in c)p.disableVertexAttribArray(c[i])}});h.Cube=function(c){h.Model.call(this,u.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,
-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},c||{}))};h.Cube.prototype=Object.create(h.Model.prototype);h.Sphere=function(c){var i=c.nlat||10,k=
c.nlong||10,l=c.radius||1,r=f-0,w=2*f-0,s=(i+1)*(k+1),A=new Float32Array(s*3),a=new Float32Array(s*3);s=new Float32Array(s*2);var b=new Uint16Array(i*k*6);if(typeof l=="number"){var g=l;l=function(){return g}}for(var o=0;o<=i;o++)for(var q=0;q<=k;q++){var t=q/k,v=o/i,z=w*t,B=r*v,C=j(z);z=n(z);var D=j(B),E=n(B);B=z*D;z=E;C*=D;D=l(B,z,C,t,v);E=q+o*(k+1);var G=E*3;E*=2;A[G+0]=D*B;A[G+1]=D*z;A[G+2]=D*C;a[G+0]=B;a[G+1]=z;a[G+2]=C;s[E+0]=t;s[E+1]=v}l=i+1;for(q=0;q<i;q++)for(o=0;o<k;o++){E=(q*k+o)*6;b[E+
0]=o*l+q;b[E+1]=o*l+q+1;b[E+2]=(o+1)*l+q;b[E+3]=(o+1)*l+q;b[E+4]=o*l+q+1;b[E+5]=(o+1)*l+q+1}h.Model.call(this,u.extend({vertices:A,indices:b,normals:a,texCoords:s},c||{}))};h.Sphere.prototype=Object.create(h.Model.prototype);h.IcoSphere=function(c){var i=c.iterations||0,k=[],l=[],r=Math.sqrt,w=Math.acos,s=Math.atan2,A=Math.PI,a=A*2;c.onAddVertex=c.onAddVertex||u.empty;var b=(1+r(5))/2,g=r(1+b*b);k.push(-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,0,0,-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,b/g,0,-1/
g,b/g,0,1/g,-b/g,0,-1/g,-b/g,0,1/g);l.push(0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1);var o=function(){var W={};return function(S,T){S*=3;T*=3;var X=(S<T?S:T)+"|"+(S>T?S:T);if(X in W)return W[X];var O=(k[S]+k[T])/2,Y=(k[S+1]+k[T+1])/2,Z=(k[S+2]+k[T+2])/2,$=r(O*O+Y*Y+Z*Z);O/=$;Y/=$;Z/=$;k.push(O,Y,Z);return W[X]=k.length/3-1}}();for(b=0;b<i;b++){var q=[],t=0;for(g=l.length;t<g;t+=3){var v=o(l[t],l[t+1]),z=o(l[t+
1],l[t+2]),B=o(l[t+2],l[t]);q.push(l[t],v,B,l[t+1],z,v,l[t+2],B,z,v,z,B)}l=q}g=l.length;i=new Float32Array(g*3);o=new Float32Array(g*2);for(b=0;b<g;b+=3){z=l[b];B=l[b+1];var C=l[b+2];q=z*3;t=B*3;v=C*3;z*=2;B*=2;C*=2;var D=k[q],E=k[q+1],G=k[q+2],I=w(G/r(D*D+E*E+G*G)),J=s(E,D);I/=A;J=1-J/a;var H=k[t],F=k[t+1],N=k[t+2],K=w(N/r(H*H+F*F+N*N)),L=s(F,H);K/=A;L=1-L/a;var P=k[v],Q=k[v+1],R=k[v+2],U=w(R/r(P*P+Q*Q+R*R)),V=s(Q,P);U/=A;V=1-V/a;D=x.cross({x:P-H,y:Q-F,z:R-N},{x:D-H,y:E-F,z:G-N}).$unit();i[q]=i[t]=
i[v]=D.x;i[q+1]=i[t+1]=i[v+1]=D.y;i[q+2]=i[t+2]=i[v+2]=D.z;o[z]=J;o[z+1]=I;o[B]=L;o[B+1]=K;o[C]=V;o[C+1]=U}h.Model.call(this,u.extend({vertices:k,indices:l,normals:i,texCoords:o},c||{}))};h.IcoSphere.prototype=Object.create(h.Model.prototype);h.TruncatedCone=function(c){var i=c.bottomRadius||0,k=c.topRadius||0,l=c.height||1,r=c.nradial||10,w=c.nvertical||10,s=!!c.topCap,A=!!c.bottomCap,a=(s?2:0)+(A?2:0),b=(r+1)*(w+1+a),g=new Float32Array(b*3),o=new Float32Array(b*3);b=new Float32Array(b*2);var q=
new Uint16Array(r*(w+a)*6),t=r+1,v=Math,z=v.atan2(i-k,l),B=v.sin,C=v.cos;v=v.PI;var D=C(z);z=B(z);A=w+(A?2:0);var E=0,G=0;for(s=s?-2:0;s<=A;s++){var I=s/w,J=l*I,H;if(s<0){J=0;I=1;H=i}else if(s>w){J=l;I=1;H=k}else H=i+(k-i)*(s/w);if(s==-2||s==w+2)I=H=0;J-=l/2;for(var F=0;F<t;F++){var N=B(F*v*2/r),K=C(F*v*2/r);g[E+0]=N*H;g[E+1]=J;g[E+2]=K*H;o[E+0]=s<0||s>w?0:N*D;o[E+1]=s<0?-1:s>w?1:z;o[E+2]=s<0||s>w?0:K*D;b[G+0]=F/r;b[G+1]=I;G+=2;E+=3}}for(s=0;s<w+a;s++)for(F=0;F<r;F++){i=(s*r+F)*6;q[i+0]=t*(s+0)+0+
F;q[i+1]=t*(s+0)+1+F;q[i+2]=t*(s+1)+1+F;q[i+3]=t*(s+0)+0+F;q[i+4]=t*(s+1)+1+F;q[i+5]=t*(s+1)+0+F}h.Model.call(this,u.extend({vertices:g,normals:o,texCoords:b,indices:q},c||{}))};h.TruncatedCone.prototype=Object.create(h.Model.prototype);h.Cone=function(c){c.topRadius=0;c.topCap=!!c.cap;c.bottomCap=!!c.cap;c.bottomRadius=c.radius||3;h.TruncatedCone.call(this,c)};h.Cone.prototype=Object.create(h.TruncatedCone.prototype);h.Cylinder=function(c){c.bottomRadius=c.radius;c.topRadius=c.radius;h.TruncatedCone.call(this,
c)};h.Cylinder.prototype=Object.create(h.TruncatedCone.prototype);h.Plane=function(c){var i=c.type,k=i.split(","),l=c[k[0]+"len"],r=c[k[1]+"len"],w=c["n"+k[0]]||1;k=c["n"+k[1]]||1;var s=c.offset,A=!!c.flipCull,a=(w+1)*(k+1),b=new Float32Array(a*3),g=new Float32Array(a*3);a=new Float32Array(a*2);var o=0,q=0;if(A)l=-l;for(var t=0;t<=k;t++)for(var v=0;v<=w;v++){var z=v/w,B=t/k;a[o+0]=A?1-z:z;a[o+1]=B;o+=2;switch(i){case "x,y":b[q+0]=l*z-l*0.5;b[q+1]=r*B-r*0.5;b[q+2]=s;g[q+0]=0;g[q+1]=0;g[q+2]=A?1:-1;
break;case "x,z":b[q+0]=l*z-l*0.5;b[q+1]=s;b[q+2]=r*B-r*0.5;g[q+0]=0;g[q+1]=A?1:-1;g[q+2]=0;break;case "y,z":b[q+0]=s;b[q+1]=l*z-l*0.5;b[q+2]=r*B-r*0.5;g[q+0]=A?1:-1;g[q+1]=0;g[q+2]=0}q+=3}i=w+1;l=[];for(t=0;t<k;t++)for(v=0;v<w;v++){r=(t*w+v)*6;l[r+0]=(t+0)*i+v;l[r+1]=(t+1)*i+v;l[r+2]=(t+0)*i+v+1;l[r+3]=(t+1)*i+v;l[r+4]=(t+1)*i+v+1;l[r+5]=(t+0)*i+v+1}h.Model.call(this,u.extend({vertices:b,normals:g,texCoords:a,indices:l},c))};h.Plane.prototype=Object.create(h.Model.prototype);h.id=u.time();PhiloGL.O3D=
h})();(function(){var y={Vertex:{},Fragment:{}},x=y.Fragment;y.Vertex.Default="#define LIGHT_MAX 4\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec4 pickingColor;\nattribute vec2 texCoord1;\nuniform mat4 viewMatrix;\nuniform mat4 viewInverseMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewProjectionMatrix;\nuniform mat4 worldMatrix;\nuniform mat4 worldInverseMatrix;\nuniform mat4 worldInverseTransposeMatrix;\nuniform mat4 objectMatrix;\nuniform vec3 cameraPosition;\nuniform bool enableLights;\nuniform vec3 ambientColor;\nuniform vec3 directionalColor;\nuniform vec3 lightingDirection;\nuniform vec3 pointLocation[LIGHT_MAX];\nuniform vec3 pointColor[LIGHT_MAX];\nuniform int numberPoints;\nuniform bool useReflection;\nvarying vec3 vReflection;\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec4 vNormal;\nvarying vec3 lightWeighting;\nvoid main(void) {\nvec4 mvPosition = worldMatrix * vec4(position, 1.0);\nvec4 transformedNormal = worldInverseTransposeMatrix * vec4(normal, 1.0);\nif(!enableLights) {\nlightWeighting = vec3(1.0, 1.0, 1.0);\n} else {\nvec3 plightDirection;\nvec3 pointWeight = vec3(0.0, 0.0, 0.0);\nfloat directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);\nfor (int i = 0; i < LIGHT_MAX; i++) {\nif (i < numberPoints) {\nplightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);\npointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];\n} else {\nbreak;\n}\n}\nlightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;\n}\nif (useReflection) {\nvReflection = (viewInverseMatrix[3] - (worldMatrix * vec4(position, 1.0))).xyz;\n} else {\nvReflection = vec3(1.0, 1.0, 1.0);\n}\nvColor = color;\nvPickingColor = pickingColor;\nvTexCoord = texCoord1;\nvNormal = transformedNormal;\ngl_Position = projectionMatrix * worldMatrix * vec4(position, 1.0);\n}";
x.Default="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nvarying vec3 vReflection;\nvarying vec4 vNormal;\nuniform bool hasTexture1;\nuniform sampler2D sampler1;\nuniform bool hasTextureCube1;\nuniform samplerCube samplerCube1;\nuniform bool enablePicking;\nuniform bool hasPickingColors;\nuniform vec3 pickColor;\nuniform float reflection;\nuniform float refraction;\nuniform bool hasFog;\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\nvoid main(){\nif (!hasTexture1) {\ngl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);\n} else {\ngl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);\n}\nif (hasTextureCube1) {\nvec3 nReflection = normalize(vReflection);\nvec3 reflectionValue;\nif (refraction > 0.0) {\nreflectionValue = refract(nReflection, vNormal.xyz, refraction);\n} else {\nreflectionValue = -reflect(nReflection, vNormal.xyz);\n}\nvec4 cubeColor = textureCube(samplerCube1, vec3(-reflectionValue.x, -reflectionValue.y, reflectionValue.z));\ngl_FragColor = vec4(mix(gl_FragColor.xyz, cubeColor.xyz, reflection), 1.0);\n}\nif (enablePicking) {\nif (hasPickingColors) {\ngl_FragColor = vPickingColor;\n} else {\ngl_FragColor = vec4(pickColor, 1.0);\n}\n}\nif (hasFog) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep(fogNear, fogFar, depth);\ngl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);\n}\n}";
PhiloGL.Shaders=y})();(function(){var y=PhiloGL.Vec3,x=function(m,n,j){j=u.merge({lights:{enable:false,ambient:{r:0.2,g:0.2,b:0.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:false}},j||{});this.program=j.program?m[j.program]:m;this.camera=n;this.models=[];this.config=j};x.prototype={add:function(){for(var m=0,n=this.models,j=arguments.length;m<j;m++){var f=arguments[m];f.id=f.id||u.uid();n.push(f);this.defineBuffers(f)}},remove:function(m){var n=this.models;m=n.indexOf(m);
m>-1&&n.splice(m,1)},getProgram:function(m){var n=this.program;if(n.$$family!="program"&&m&&m.program){n=n[m.program];n.use()}return n},defineBuffers:function(m){var n=this.getProgram(m),j=m.dynamic;m.dynamic=true;m.setState(n);m.dynamic=j;m.unsetState(n)},beforeRender:function(m){this.setupLighting(m);this.setupEffects(m);this.camera&&this.camera.setStatus(m)},setupLighting:function(m){var n=this.config.lights,j=n.ambient,f=n.directional,d=f.color,h=f.direction,c=n.enable;n=n.points&&u.splat(n.points)||
[];f=n.length;var i=[],k=[],l=[],r=[];h=(new y(h.x,h.y,h.z)).$unit().$scale(-1);m.setUniform("enableLights",c);if(c){m.setUniform("ambientColor",[j.r,j.g,j.b]);m.setUniform("directionalColor",[d.r,d.g,d.b]);m.setUniform("lightingDirection",[h.x,h.y,h.z]);m.setUniform("numberPoints",f);for(j=0;j<f;j++){c=n[j];d=c.position;h=c.color||c.diffuse;c=c.specular;i.push(d.x,d.y,d.z);k.push(h.r,h.g,h.b);l.push(+!!c);c?r.push(c.r,c.g,c.b):r.push(0,0,0)}if(i.length){m.setUniforms({pointLocation:i,pointColor:k});
m.setUniforms({enableSpecular:l,pointSpecularColor:r})}}},setupEffects:function(m){var n=this.config.effects.fog,j=n.color||{r:0.5,g:0.5,b:0.5};n?m.setUniforms({hasFog:true,fogNear:n.near,fogFar:n.far,fogColor:[j.r,j.g,j.b]}):m.setUniform("hasFog",false)},render:function(m){m=m||{};var n=this.camera,j=this.program,f=m.renderProgram,d=u.type(j);d=!f&&d=="object";m=u.extend({onBeforeRender:u.empty,onAfterRender:u.empty},m||{});!d&&this.beforeRender(f||j);for(var h=0,c=this.models,i=c.length;h<i;++h){var k=
c[h];if(k.display){j=f||this.getProgram(k);d&&this.beforeRender(j);k.onBeforeRender(j,n);m.onBeforeRender(k,h);this.renderObject(k,j);m.onAfterRender(k,h);k.onAfterRender(j,n)}}},renderToTexture:function(m,n){n=n||{};var j=M.textures[m+"-texture"],f=M.textureMemo[m+"-texture"];this.render(n);p.bindTexture(f.textureType,j)},renderObject:function(m,n){var j=this.camera,f=m.matrix,d=j.view.mulMat4(f),h=d.invert(),c=h.transpose();m.setState(n);n.setUniforms({objectMatrix:f,worldMatrix:d,worldInverseMatrix:h,
worldInverseTransposeMatrix:c});if(m.render)m.render(p,n,j);else m.$indicesLength?p.drawElements(m.drawType!==undefined?p.get(m.drawType):p.TRIANGLES,m.$indicesLength,p.UNSIGNED_SHORT,0):p.drawArrays(m.drawType!==undefined?p.get(m.drawType):p.TRIANGLES,0,m.$verticesLength/3);m.unsetState(n)},setupPicking:function(){var m=PhiloGL.Program.fromDefaultShaders();M.setFrameBuffer("$picking",{width:5,height:1,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",
value:"LINEAR"},{name:"TEXTURE_WRAP_S",value:"CLAMP_TO_EDGE"},{name:"TEXTURE_WRAP_T",value:"CLAMP_TO_EDGE"}]},bindToRenderBuffer:true});M.setFrameBuffer("$picking",false);this.pickingProgram=m},pick:function(m,n,j){j=j||{};this.pickingProgram||this.setupPicking();var f={},d=[],h=M.usedProgram,c=this.pickingProgram,i=this.camera,k=i.target,l=i.aspect,r=this.config,w=r.lights.enable,s=r.effects.fog,A=p.canvas;j=j.viewport||{};var a=j.width||A.offsetWidth||A.width;A=j.height||A.offsetHeight||A.height;
var b=this.unproject([(m-(j.x||0))*2/a-1,1-(n-(j.y||0))*2/A,1],i),g=new Uint8Array(4);this.camera.target=b;this.camera.update();r.lights.enable=false;r.effects.fog=false;M.setFrameBuffer("$picking",true);c.use();c.setUniform("enablePicking",true);p.disable(p.BLEND);p.viewport(0,0,5,1);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);p.readPixels(0,0,1,1,p.RGBA,p.UNSIGNED_BYTE,g);this.renderPickingScene({background:g[0]+g[1]*256+g[2]*65536,o3dHash:f,o3dList:d,hash:[]});p.readPixels(2,0,1,1,p.RGBA,p.UNSIGNED_BYTE,
g);var o=[g[0],g[1],g[2]].join();b=f[o];console.log("o3dHash",o,m,n,a,A);if(!b){n=0;for(o=d.length;n<o;n++){b=d[n];m=b.pick(g);if(m!==false)b.$pickingIndex=m;else b=false}}M.setFrameBuffer("$picking",false);M.setTexture("$picking-texture",false);c.setUniform("enablePicking",false);r.lights.enable=w;r.effects.fog=s;h&&h.use();p.viewport(j.x||0,j.y||0,a,A);i.target=k;i.aspect=l;i.update();this.o3dHash=f;this.o3dList=d;this.pixel=g;this.capture=void 0;return b&&b.pickable&&b},unproject:function(m,n){return n.view.invert().mulMat4(n.projection.invert()).mulVec3(m)},
renderPickingScene:function(m){if(this.config.renderPickingScene)this.config.renderPickingScene.call(this,m);else{var n=this.pickingProgram,j=m.o3dHash,f=m.o3dList,d=m.background,h=m.hash,c=0;this.renderToTexture("$picking",{renderProgram:n,onBeforeRender:function(i,k){if(k==d)c=1;var l=k+c,r=!!i.pickingColors;n.setUniform("hasPickingColors",r);if(r)f.push(i);else{h[0]=l%256;h[1]=(l/256>>0)%256;h[2]=(l/65536>>0)%256;n.setUniform("pickColor",[h[0]/255,h[1]/255,h[2]/255]);j[h.join()]=i}}})}},resetPicking:u.empty};
x.MAX_TEXTURES=10;x.MAX_POINT_LIGHTS=4;x.PICKING_RES=4;PhiloGL.Scene=x})();(function(){function y(x,m){for(var n=this.workers=[];m--;)n.push(new Worker(x))}y.prototype={map:function(x){var m=this.workers,n=this.configs=[],j=0;for(m=m.length;j<m;j++)n.push(x&&x(j));return this},reduce:function(x){for(var m=x.reduceFn,n=this.workers,j=this.configs,f=n.length,d=x.initialValue,h=function(l){f--;d=d===undefined?l.data:m(d,l.data);if(f==0)x.onComplete(d)},c=0,i=f;c<i;c++){var k=n[c];k.onmessage=h;k.postMessage(j[c])}return this}};
PhiloGL.WorkerGroup=y})();(function(){var y=function(d){this.opt=u.merge({delay:0,duration:1E3,transition:function(h){return h},onCompute:u.empty,onComplete:u.empty},d||{})},x=y.Queue=[];y.prototype={time:null,start:function(d){this.opt=u.merge(this.opt,d||{});this.time=u.time();this.animating=true;x.push(this)},step:function(){if(this.animating){var d=u.time(),h=this.time,c=this.opt,i=c.delay,k=c.duration,l=0;if(d<h+i)c.onCompute.call(this,l);else if(d<h+i+k){l=c.transition((d-h-i)/k);c.onCompute.call(this,
l)}else{this.animating=false;c.onCompute.call(this,1);c.onComplete.call(this)}}}};y.compute=function(d,h,c){return d+(h-d)*c};y.Transition={linear:function(d){return d}};var m=y.Transition;(function(){var d=function(i,k){k=u.splat(k);return u.extend(i,{easeIn:function(l){return i(l,k)},easeOut:function(l){return 1-i(1-l,k)},easeInOut:function(l){return l<=0.5?i(2*l,k)/2:(2-i(2*(1-l),k))/2}})},h={Pow:function(i,k){return Math.pow(i,k[0]||6)},Expo:function(i){return Math.pow(2,8*(i-1))},Circ:function(i){return 1-
Math.sin(Math.acos(i))},Sine:function(i){return 1-Math.sin((1-i)*Math.PI/2)},Back:function(i,k){k=k[0]||1.618;return Math.pow(i,2)*((k+1)*i-k)},Bounce:function(i){for(var k,l=0,r=1;;l+=r,r/=2)if(i>=(7-4*l)/11){k=r*r-Math.pow((11-6*l-11*i)/4,2);break}return k},Elastic:function(i,k){return Math.pow(2,10*--i)*Math.cos(20*i*Math.PI*(k[0]||1)/3)}},c;for(c in h)m[c]=d(h[c]);["Quad","Cubic","Quart","Quint"].forEach(function(i,k){m[i]=d(function(l){return Math.pow(l,[k+2])})})})();var n=self||window,j=function(){var d=
x;x=[];if(d.length){for(var h=0,c=d.length,i;h<c;h++){i=d[h];i.step();i.animating&&x.push(i)}y.Queue=x}};if(n){var f=false;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime","animationStartTime"].forEach(function(d){if(d in n){y.animationTime=function(){return n[d]};f=true}});if(!f)y.animationTime=u.time;f=false;["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(d){if(d in n){y.requestAnimationFrame=
function(h){n[d](function(){j();h()})};f=true}});if(!f)y.requestAnimationFrame=function(d){setTimeout(function(){j();d()},1E3/60)}}PhiloGL.Fx=y})();(function(){var y={},x=function(){};x.postProcess=function(){var m=new PhiloGL.O3D.Plane({type:"x,y",xlen:1,ylen:1,offset:0}),n=new PhiloGL.Camera(45,1,0.1,500,{position:{x:0,y:0,z:1.205}}),j=new PhiloGL.Scene({},n);return function(f){var d=M.program.$$family?M.program:M.program[f.program],h=f.fromTexture?u.splat(f.fromTexture):[],c=f.toFrameBuffer,i=
!!f.toScreen,k=f.width||M.canvas.width,l=f.height||M.canvas.height,r=f.viewportX||0,w=f.viewportY||0;n.aspect=f.aspectRatio?f.aspectRatio:Math.max(l/k,k/l);n.update();j.program=d;m.textures=h;m.program=d;j.models.length||j.add(m);if(c){c in M.frameBufferMemo||M.setFrameBuffer(c,{width:k,height:l,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR",generateMipmap:false}]},bindToRenderBuffer:false});d.use();M.setFrameBuffer(c,true);p.viewport(r,
w,k,l);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);d.setUniforms(f.uniforms||{});j.renderToTexture(c);M.setFrameBuffer(c,false)}if(i){d.use();p.viewport(r,w,k,l);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);d.setUniforms(f.uniforms||{});j.render()}return this}}();y.Image=x;PhiloGL.Media=y})()})();
